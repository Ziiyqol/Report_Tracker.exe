name: Build and Release

on:
  release:
    types: [created]

jobs:
  # ------------------------------------------------------------------
  # ЗАДАЧА 1: Сборка для Windows
  # Запускается на Linux, использует fyne-cross (Docker)
  # Это самый надежный способ собрать .exe
  # ------------------------------------------------------------------
  build_windows:
    name: Build Windows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install fyne-cross
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Build Windows Binary
        # Собираем Windows версию. Иконка в cmd/icon.png
        run: |
          fyne-cross windows -arch amd64 \
            --icon cmd/icon.png \
            --app-id com.report.tracker \
            --name ReportTracker \
            --output ReportTracker

      - name: Prepare Artifact
        run: |
          # Перемещаем готовый exe в корень и даем нормальное имя
          mv fyne-cross/bin/windows-amd64/ReportTracker.exe ReportTracker_Windows_x64.exe

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ReportTracker_Windows_x64.exe

  # ------------------------------------------------------------------
  # ЗАДАЧА 2: Сборка для macOS (Intel и M1)
  # Запускается на настоящем macOS.
  # НЕ использует fyne-cross. Использует нативный Fyne CLI.
  # ------------------------------------------------------------------
  build_macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Fyne CLI
        # Устанавливаем официальную утилиту Fyne v2
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      # --- Сборка для Intel (amd64) ---
      - name: Build macOS Intel
        run: |
          # Устанавливаем переменные окружения для целевой архитектуры
          export CGO_ENABLED=1
          export GOOS=darwin
          export GOARCH=amd64
          
          # Собираем пакет .app
          fyne package -os darwin -icon cmd/icon.png --appID com.report.tracker --name ReportTracker
          
          # Переименовываем, чтобы не было конфликтов
          mv ReportTracker.app ReportTracker_Intel.app
          
          # Архивируем в tar.gz (обязательно для macOS приложений)
          tar -czf ReportTracker_macOS_Intel.tar.gz ReportTracker_Intel.app

      # --- Сборка для Apple Silicon (arm64/M1) ---
      - name: Build macOS Apple Silicon
        run: |
          export CGO_ENABLED=1
          export GOOS=darwin
          export GOARCH=arm64
          
          # Собираем пакет .app
          fyne package -os darwin -icon cmd/icon.png --appID com.report.tracker --name ReportTracker
          
          # Переименовываем
          mv ReportTracker.app ReportTracker_M1.app
          
          # Архивируем
          tar -czf ReportTracker_macOS_M1.tar.gz ReportTracker_M1.app

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ReportTracker_macOS_Intel.tar.gz
            ReportTracker_macOS_M1.tar.gz
