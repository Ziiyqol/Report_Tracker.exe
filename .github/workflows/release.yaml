name: Build and Release

on:
  release:
    types: [created]

jobs:

prepare_darwin:
    name: Prepare Darwin SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup fyne-cross
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          
      - name: Extract Darwin SDK
        # Эта команда скачает необходимый SDK в Docker-образ
        # Это может занять 5-10 минут!
        run: fyne-cross darwin-sdk-extract
        
      - name: Clean up
        # Удаляем ненужные файлы, чтобы не хранить их в репозитории
        run: rm -f *.dmg
        
  build:
    name: Build for ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - os: windows
            arch: amd64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Setup fyne-cross
        # Устанавливаем fyne-cross и добавляем его в PATH
        run: |
          go install github.com/fyne-io/fyne-cross@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run Fyne-Cross Build
        # ИСПРАВЛЕНИЕ ЗДЕСЬ: Используем команду ОС и флаг -arch
        run: |
          fyne-cross ${{ matrix.os }} \
            -arch ${{ matrix.arch }} \
            --icon cmd/icon.png \
            --app-id com.report.tracker \
            --name ReportTracker \
            --output ReportTracker

      - name: Prepare Artifact Names
        id: prepare_artifacts
        run: |
          # Fyne-cross сохраняет файлы в fyne-cross/bin/[platform]-[arch]/
          OS_ARCH="${{ matrix.os }}-${{ matrix.arch }}"
          
          if [[ "${{ matrix.os }}" == "windows" ]]; then
              SOURCE_PATH="fyne-cross/bin/${OS_ARCH}/ReportTracker.exe"
              ARTIFACT_NAME="ReportTracker_Windows_x64.exe"
          elif [[ "${{ matrix.os }}" == "darwin" ]]; then
              SOURCE_PATH="fyne-cross/bin/${OS_ARCH}/ReportTracker.app.tar.gz"
              
              if [[ "${{ matrix.arch }}" == "amd64" ]]; then
                  ARTIFACT_NAME="ReportTracker_macOS_Intel.tar.gz"
              else
                  ARTIFACT_NAME="ReportTracker_macOS_M1.tar.gz"
              fi
          fi
          
          echo "SOURCE_PATH=${SOURCE_PATH}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV
          
      - name: Copy Artifact to Root
        # Перемещаем файл в корень для удобной загрузки
        run: mv ${{ env.SOURCE_PATH }} ${{ env.ARTIFACT_NAME }}

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_NAME }}
