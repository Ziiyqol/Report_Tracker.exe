name: Build and Release

on:
  release:
    types: [created]

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: windows
            goos: windows
            goarch: amd64
            ext: .exe
          - os: darwin
            goos: darwin
            goarch: amd64 # Intel Mac
            ext: .app.tar.gz # Fyne упакует это сам
          - os: darwin_arm64
            goos: darwin
            goarch: arm64 # M1/M2 Mac
            ext: .app.tar.gz

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Install dependencies
        # Нужно для Linux-воркера, который собирает приложение (графические библиотеки)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev xorg-dev

      - name: Build Windows
        if: matrix.os == 'windows'
        run: |
          fyne package -os windows -icon icon.png --appID com.report.tracker
          mv report.exe ReportTracker_Windows.exe

      - name: Build macOS (Intel)
        if: matrix.os == 'darwin'
        run: |
          fyne package -os darwin -icon icon.png --appID com.report.tracker
          tar -czf ReportTracker_macOS_Intel.tar.gz report.app

      - name: Build macOS (Apple Silicon)
        if: matrix.os == 'darwin_arm64'
        run: |
          fyne package -os darwin -arch arm64 -icon icon.png --appID com.report.tracker
          tar -czf ReportTracker_macOS_M1.tar.gz report.app

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ReportTracker_Windows.exe
            ReportTracker_macOS_Intel.tar.gz
            ReportTracker_macOS_M1.tar.gz